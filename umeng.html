<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ´»åŠ¨åˆ†äº« - æ‰“å¼€App</title>
    <style>
        /* å¤ç”¨ä¹‹å‰çš„ CSS æ ·å¼ */
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 20px;
            background-color: #f4f4f4;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            text-align: center;
        }
        .container {
            background-color: #fff;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            max-width: 500px;
            width: 90%;
        }
        h1 {
            color: #333;
            margin-bottom: 15px;
        }
        p {
            color: #555;
            margin-bottom: 25px;
        }
        .action-button { /* ä¸»è¦çš„ ULink è§¦å‘æŒ‰é’® */
            background-color: #28a745; /* Green color */
            color: white;
            border: none;
            padding: 15px 25px;
            border-radius: 25px; /* Pill shape */
            cursor: pointer;
            font-size: 1.1em;
            font-weight: bold;
            transition: background-color 0.3s ease;
            margin-bottom: 20px;
            display: block;
            width: 80%;
            margin-left: auto;
            margin-right: auto;
        }
        .action-button:hover {
            background-color: #218838;
        }
        .clipboard-area {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #eee;
        }
        #clipboardOutput {
            width: calc(100% - 22px);
            padding: 10px;
            margin-bottom: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.9em;
            background-color: #f9f9f9;
            color: #333;
            -webkit-user-select: all;
            -moz-user-select: all;
            -ms-user-select: all;
            user-select: all;
            text-align: left; /* Align text left for better readability */
            min-height: 40px; /* Ensure it has some height even when empty */
            box-sizing: border-box;
             /* Make it look like output, not input */
            overflow-wrap: break-word; /* Wrap long text */
        }
         #copyManualButton {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9em;
            transition: background-color 0.3s ease;
        }
        #copyManualButton:hover {
            background-color: #0056b3;
        }
        #copyFeedback {
            margin-top: 8px;
            color: green;
            font-size: 0.9em;
            height: 1.2em;
        }
        /* Custom Download Style Elements (initially hidden perhaps) */
        #downloadStyle {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        #download-window {
            width: 70%;
            max-width: 350px;
            background-color: #fff;
            border: 1px solid #ccc;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            position: relative; /* Needed for absolute positioning of close button */
            text-align: center;
        }
         #download-window .close-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            cursor: pointer;
            font-size: 1.2em;
            color: #aaa;
            line-height: 1;
         }
         #download-window .close-btn:hover {
            color: #333;
         }
        #download-window p {
            margin-bottom: 20px;
            color: #333;
        }
        #download-window button {
           width: 80%;
           height: 40px;
           background-color: #3b82fe;
           color: #fff;
           border-radius: 20px;
           border: none;
           margin: 0 auto;
           display: block;
           cursor: pointer;
           font-size: 1em;
        }
         #download-window button:hover {
             background-color: #2066d3;
         }

    </style>
    <script type="text/javascript" charset="UTF-8" src="https://g.alicdn.com/jssdk/u-link/index.min.js"></script> 
    </head>
<body>
    <div class="container">
        <h1>ğŸš€ å¿«æ¥ä½“éªŒæˆ‘ä»¬çš„Appï¼ ğŸš€</h1>
        <p>ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®ï¼Œå³å¯è½»æ¾æ‰“å¼€Appæˆ–å‰å¾€ä¸‹è½½ã€‚</p>

        <button id="Go_TO_APP" class="action-button">æ‰“å¼€æˆ–ä¸‹è½½App</button>

        <div class="clipboard-area">
            <label for="clipboardOutput" style="display:block; margin-bottom: 5px; font-weight: bold; color: #333;">åˆ†äº«ä¿¡æ¯ (ä¾›Appå†…ä½¿ç”¨):</label>
            <div id="clipboardOutput" role="textbox" aria-readonly="true" contenteditable="false"></div> 
            <button id="copyManualButton">å¤åˆ¶ä¿¡æ¯</button>
            <p id="copyFeedback"></p>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const clipboardOutput = document.getElementById('clipboardOutput');
            const copyManualButton = document.getElementById('copyManualButton');
            const copyFeedback = document.getElementById('copyFeedback');

            // --- é…ç½®ä¿¡æ¯ ---
            // 1. æ›¿æ¢æˆä½ åœ¨å‹ç›Ÿåå° -> ç”¨æˆ·æ¸ é“ -> åˆ›å»ºæ¨å¹¿æ´»åŠ¨ -> ç”Ÿæˆçš„ Link ID
            const ulinkLinkID = "usr11htcjducb9c6"; // <--- åœ¨è¿™é‡Œæ›¿æ¢ä½ çš„ Link ID

            // 2. ç¡®è®¤ä½ çš„åº”ç”¨å­˜å‚¨è¿½è¸ªç  (tc) ä½¿ç”¨çš„ localStorage Key
            const localStorageTrackCodeKey = "track_code"; // <--- å¦‚æœä½ çš„ Key ä¸åŒï¼Œè¯·ä¿®æ”¹è¿™é‡Œ

            // --- ä» localStorage è¯»å– tc ---
            const trackCode = localStorage.getItem(localStorageTrackCodeKey);

            // --- è‡ªå®šä¹‰ä¸‹è½½/æ‰“å¼€å¤±è´¥å¤„ç†å‡½æ•° ---
            function myDownloadStyle(defaultAction, LinkInstance) {
                 console.log("myDownloadStyle triggered. OS:", LinkInstance.env.os, "Download URL:", LinkInstance.solution?.downloadUrl);

                // è§£å†³å®‰å“æœªå®‰è£…ï¼Œæ— æ³•ä¸‹è½½è·³è½¬é—®é¢˜ (æ ¹æ® React ä»£ç é€»è¾‘)
                if (LinkInstance.env.os === 'android' && LinkInstance.solution?.downloadUrl) {
                     console.log("Android detected, redirecting to download URL:", LinkInstance.solution.downloadUrl);
                     window.location.href = LinkInstance.solution.downloadUrl;
                     return; // é˜»æ­¢åç»­é»˜è®¤è¡Œä¸ºæˆ–å¼¹çª—
                 }

                // -------------- åŸ React ä»£ç ä¸­çš„è‡ªå®šä¹‰å¼¹çª—é€»è¾‘ (å¯é€‰) --------------
                 // å¦‚æœä½ æƒ³ä½¿ç”¨è‡ªå®šä¹‰å¼¹çª—è€Œä¸æ˜¯ç›´æ¥è·³è½¬ (éå®‰å“æˆ–å®‰å“æ— ä¸‹è½½é“¾æ¥æ—¶)
                 const useCustomDownloadPopup = false; // è®¾ç½®ä¸º true ä»¥å¯ç”¨ä¸‹é¢çš„å¼¹çª—

                 if (useCustomDownloadPopup && LinkInstance.solution?.downloadUrl) {
                     // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨å¼¹çª—
                     if (document.getElementById('downloadStyle')) {
                         return;
                     }

                     const downloadStyleDom = document.createElement('div');
                     downloadStyleDom.setAttribute('id', 'downloadStyle');
                     downloadStyleDom.innerHTML = `
                         <div id="download-window">
                             <div class="close-btn" onclick="window.ulinkCloseDownloadTip()">&times;</div>
                             <p>åº”ç”¨æœªå®‰è£…ï¼Œè¯·ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®è·³è½¬è‡³å•†åº—è¿›è¡Œä¸‹è½½!</p>
                             <button onclick="window.ulinkOpenDownload()">ç«‹å³ä¸‹è½½</button>
                         </div>`;

                     // å°†å…³é—­å’Œæ‰“å¼€å‡½æ•°æŒ‚è½½åˆ° window
                     window.ulinkCloseDownloadTip = function () {
                         const element = document.getElementById('downloadStyle');
                         if (element) {
                             element.remove();
                         }
                     };
                     window.ulinkOpenDownload = function () {
                         console.log("Download button clicked. Redirecting to:", LinkInstance.solution.downloadUrl);
                         window.location.href = LinkInstance.solution.downloadUrl;
                         window.ulinkCloseDownloadTip(); // ç‚¹å‡»ä¸‹è½½åä¹Ÿå…³é—­å¼¹çª—
                     };

                     document.body.appendChild(downloadStyleDom);
                 } else if (LinkInstance.env.os !== 'android') {
                     // å¯¹äºéå®‰å“è®¾å¤‡ï¼Œå¦‚æœä¸ä½¿ç”¨è‡ªå®šä¹‰å¼¹çª—ï¼Œå¯ä»¥è°ƒç”¨é»˜è®¤è¡Œä¸º
                     // æˆ–æ ¹æ®éœ€è¦å¤„ç†ï¼Œä¾‹å¦‚ç›´æ¥è·³è½¬ä¸‹è½½é“¾æ¥ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                     console.log("Non-Android or no custom popup. Calling defaultAction.");
                     defaultAction(); // å¯¹äºiOSç­‰ï¼Œé»˜è®¤è¡Œä¸ºé€šå¸¸æ˜¯è·³è½¬App Store
                 } else {
                    // å®‰å“èµ°åˆ°è¿™é‡Œè¯´æ˜æ²¡æœ‰ downloadUrl æˆ–ä¸æ»¡è¶³ç›´æ¥è·³è½¬æ¡ä»¶ï¼Œå¯ä»¥è°ƒç”¨ defaultAction
                    // defaultAction å¯èƒ½ä¼šå°è¯•å…¶ä»–å”¤èµ·æ–¹å¼æˆ–æ˜¾ç¤ºå†…ç½®æç¤º
                     console.log("Android case not handled by direct redirect or custom popup. Calling defaultAction.");
                    defaultAction();
                 }
                 // -------------- è‡ªå®šä¹‰å¼¹çª—é€»è¾‘ç»“æŸ --------------

                 // å¦‚æœä¸Šé¢æ‰€æœ‰é€»è¾‘éƒ½ä¸æ‰§è¡Œï¼Œå¹¶ä¸”ä½ ä¸æƒ³æ‰§è¡Œä»»ä½•æ“ä½œï¼Œå°±ç›´æ¥ return;
                 // return; 
                 // å¦‚æœä½ æƒ³åœ¨æ‰€æœ‰è‡ªå®šä¹‰é€»è¾‘åæ€»æ˜¯æ‰§è¡Œé»˜è®¤æ“ä½œï¼ˆé™¤éå·² returnï¼‰ï¼Œåˆ™è°ƒç”¨ï¼š
                 // defaultAction();
            }

            // --- åˆå§‹åŒ– U-Link ---
            if (window.ULink) {
                console.log("ULink SDK found. Initializing...");
                try {
                   window.ULink({
                        id: ulinkLinkID,
                        data: { // å°† tc æ”¾å…¥ data å¯¹è±¡
                            tc: trackCode || "", // å¦‚æœ tc ä¸å­˜åœ¨ï¼Œä¼ ç©ºå­—ç¬¦ä¸²
                        },
                        selector: "#Go_TO_APP", // ç»‘å®šåˆ°æŒ‰é’®
                        timeout: 2000,
                        useOpenInBrowerTips: "default", // å¯ä»¥ä½¿ç”¨é»˜è®¤çš„æµè§ˆå™¨æç¤º
                        lazy: false, // ä¸å»¶è¿ŸåŠ è½½
                        auto: false,  // ä¸è‡ªåŠ¨æ‰§è¡Œï¼Œç”± selector ç‚¹å‡»è§¦å‘
                        useClipboard: false, // æ ¹æ®ä½ çš„ React ä»£ç è®¾ç½®ä¸º false
                        proxyOpenDownload: myDownloadStyle, // ä½¿ç”¨è‡ªå®šä¹‰ä¸‹è½½å¤„ç†å‡½æ•°
                        onready: function (ctx) {
                            console.log("ULink onready callback. Context:", ctx);
                            let textToCopy = "";
                            var u = navigator.userAgent;
                            var isAndroid = u.indexOf("Android") > -1 || u.indexOf("Adr") > -1;

                            // å®‰å“ç‰¹æ®Šå¤„ç†ï¼šå¤åˆ¶ tc å‚æ•°
                            if (isAndroid) {
                                console.log("Android detected in onready.");
                                if (trackCode) {
                                    textToCopy = "tc=" + trackCode;
                                    console.log("Android + trackCode found. Setting text to copy:", textToCopy);
                                } else {
                                    console.log("Android, but no trackCode found in localStorage.");
                                }
                            }
                            
                            // å¦‚æœä¸æ˜¯å®‰å“ï¼Œæˆ–è€…å®‰å“æ²¡æœ‰ tcï¼Œå°è¯•ä½¿ç”¨ ULink æä¾›çš„ clipboardToken
                            if (!textToCopy && ctx.solution?.clipboardToken) {
                                textToCopy = ctx.solution.clipboardToken;
                                console.log("Using clipboardToken:", textToCopy);
                            }

                            // æ›´æ–°é¡µé¢ä¸Šçš„æ˜¾ç¤ºåŒºåŸŸ
                            clipboardOutput.textContent = textToCopy || "ï¼ˆæ— å¯ç”¨åˆ†äº«ä¿¡æ¯ï¼‰"; // æ˜¾ç¤ºè·å–åˆ°çš„æ–‡æœ¬æˆ–æç¤º
                            if (!textToCopy) {
                                copyManualButton.disabled = true; // å¦‚æœæ²¡æœ‰å†…å®¹ï¼Œç¦ç”¨å¤åˆ¶æŒ‰é’®
                                copyManualButton.style.opacity = 0.5;
                            } else {
                                copyManualButton.disabled = false;
                                copyManualButton.style.opacity = 1;
                            }
                        },
                        // å¯ä»¥æ·»åŠ  onerror å›è°ƒæ¥å¤„ç†åˆå§‹åŒ–é”™è¯¯
                        onerror: function(error) {
                            console.error("ULink initialization error:", error);
                            clipboardOutput.textContent = "ULink åˆå§‹åŒ–å¤±è´¥";
                            copyManualButton.disabled = true;
                            copyManualButton.style.opacity = 0.5;
                        }
                    });
                } catch (e) {
                     console.error("Error during ULink initialization:", e);
                     clipboardOutput.textContent = "ULink è°ƒç”¨å‡ºé”™";
                     copyManualButton.disabled = true;
                     copyManualButton.style.opacity = 0.5;
                }

            } else {
                console.error("ULink SDK not loaded!");
                clipboardOutput.textContent = "ULink SDK åŠ è½½å¤±è´¥";
                // ç¦ç”¨ä¸»è¦æŒ‰é’®å’Œå¤åˆ¶æŒ‰é’®
                 const actionButton = document.getElementById('Go_TO_APP');
                 if(actionButton) {
                    actionButton.disabled = true;
                    actionButton.style.opacity = 0.5;
                    actionButton.textContent = "åŠ è½½å¤±è´¥";
                 }
                copyManualButton.disabled = true;
                copyManualButton.style.opacity = 0.5;
            }

            // --- æ‰‹åŠ¨å¤åˆ¶æŒ‰é’®é€»è¾‘ ---
            copyManualButton.addEventListener('click', () => {
                const textToCopy = clipboardOutput.textContent;
                if (!textToCopy || textToCopy === "ï¼ˆæ— å¯ç”¨åˆ†äº«ä¿¡æ¯ï¼‰" || textToCopy.includes("å¤±è´¥") || textToCopy.includes("å‡ºé”™")) {
                    copyFeedback.textContent = 'æ²¡æœ‰å¯å¤åˆ¶çš„å†…å®¹';
                    copyFeedback.style.color = 'orange';
                     setTimeout(() => { copyFeedback.textContent = ''; }, 2000);
                    return;
                }

                navigator.clipboard.writeText(textToCopy).then(() => {
                    copyFeedback.textContent = 'âœ… ä¿¡æ¯å·²å¤åˆ¶!';
                    copyFeedback.style.color = 'green';
                    copyManualButton.textContent = 'å·²å¤åˆ¶!';
                    setTimeout(() => {
                        copyManualButton.textContent = 'å¤åˆ¶ä¿¡æ¯';
                        copyFeedback.textContent = '';
                    }, 2000);
                }).catch(err => {
                    console.error('æ‰‹åŠ¨å¤åˆ¶å¤±è´¥: ', err);
                    copyFeedback.textContent = 'âŒ å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨é€‰æ‹©å¤åˆ¶ã€‚';
                    copyFeedback.style.color = 'red';
                     setTimeout(() => { copyFeedback.textContent = ''; }, 3000);
                });
            });
        });
    </script>
</body>
</html>